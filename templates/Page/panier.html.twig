{% extends 'base.html.twig' %}

{% block title %}Mon Panier - CreaSelf{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/panier.css') }}">
{% endblock %}

{% block body %}
<main class="cart-experience">
    <div class="cart-container">
        <!-- En-t√™te de page -->
        <header class="cart-header">
            <h1 class="fade-in">
                Votre <span class="pink-neon-text italic">S√©lection</span>
            </h1>
            <p class="cart-subtitle">
                {{ panier.nombre_articles ?? 0 }} Tr√©sors pr√™ts √† √™tre d√©gust√©s
            </p>
        </header>

        {% if panier.is_empty is defined and panier.is_empty %}
            <!-- Panier vide -->
            <div class="empty-cart glass-premium">
                <i class="fa-solid fa-basket-shopping empty-icon"></i>
                <h2>Votre panier est vide</h2>
                <p>D√©couvrez nos d√©licieux cookies et boxes gourmandes !</p>
                <a href="{{ path('app_home') }}" class="btn-back-shop">
                    <i class="fas fa-arrow-left"></i>
                    Retour √† la boutique
                </a>
            </div>
        {% else %}
            <!-- Panier avec articles -->
            <div class="cart-layout">
                <!-- Liste des produits -->
                <section class="cart-items-wrapper">
                    
                    {# ========== PANIER BDD (Utilisateur connect√©) ========== #}
                    {% if panier.lignes is defined %}
                        {% for ligne in panier.lignes %}
                            <div class="cart-row glass-premium" data-id="{{ ligne.id }}" data-type="{{ ligne.produit is not null ? 'Cookie' : (ligne.isBoxPersonnalisable ? 'Box Personnalis√©e' : 'Box') }}">
                                
                                <!-- Image du produit -->
                                <div class="product-preview">
                                    <div class="img-glow-wrap">
                                        {% if ligne.produit is not null %}
                                            <img src="{{ asset('asset/images/produits/' ~ ligne.produit.image) }}" 
                                                 alt="{{ ligne.nomArticle }}"
                                                 onerror="this.src='https://via.placeholder.com/150/FF6B8F/FFFFFF?text=Cookie'">
                                        {% elseif ligne.box is not null %}
                                            <img src="{{ asset('asset/images/boxs/' ~ ligne.box.image) }}" 
                                                 alt="{{ ligne.nomArticle }}"
                                                 onerror="this.src='https://via.placeholder.com/150/FF6B8F/FFFFFF?text=Box'">
                                        {% else %}
                                            <img src="https://via.placeholder.com/150/FF6B8F/FFFFFF?text=Article" 
                                                 alt="{{ ligne.nomArticle }}">
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- D√©tails du produit -->
                                <div class="product-details">
                                    <span class="product-category">
                                        {% if ligne.produit is not null %}
                                            COOKIE ARTISANAL
                                        {% elseif ligne.isBoxPersonnalisable %}
                                            BOX PERSONNALIS√âE
                                        {% elseif ligne.box is not null %}
                                            BOX {{ ligne.box.type|upper }}
                                        {% else %}
                                            ARTICLE
                                        {% endif %}
                                    </span>
                                    <h3>{{ ligne.nomArticle }}</h3>
                                    
                                    <!-- Composition box perso -->
                                    {% if ligne.isBoxPersonnalisable and ligne.compositionsPanier is not empty %}
                                        <div class="box-composition">
                                            <p class="flavor-notes">üì¶ Composition :</p>
                                            <div class="composition-list">
                                                {% for compo in ligne.compositionsPanier %}
                                                    <span class="composition-item">
                                                        {{ compo.quantite }}x {{ compo.produit.name }}
                                                    </span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% else %}
                                        <p class="flavor-notes">Prix unitaire : {{ ligne.prixUnitaire|number_format(2, ',', ' ') }} ‚Ç¨</p>
                                    {% endif %}
                                </div>

                                <!-- Quantit√© -->
                                <div class="product-qty">
                                    {% if not ligne.isBoxPersonnalisable %}
                                        <div class="qty-stepper">
                                            <button onclick="changeQtyDB({{ ligne.id }}, '{{ ligne.produit is not null ? 'Cookie' : 'Box' }}', -1)">‚àí</button>
                                            <input type="text" value="{{ ligne.quantite }}" readonly>
                                            <button onclick="changeQtyDB({{ ligne.id }}, '{{ ligne.produit is not null ? 'Cookie' : 'Box' }}', 1)">+</button>
                                        </div>
                                    {% else %}
                                        <div class="qty-display">
                                            Quantit√© : {{ ligne.quantite }}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Prix et suppression -->
                                <div class="product-price">
                                    <span class="total-item-price">{{ ligne.sousTotal|number_format(2, ',', ' ') }} ‚Ç¨</span>
                                    <button class="btn-remove" onclick="removeItemDB({{ ligne.id }}, '{{ ligne.produit is not null ? 'Cookie' : 'Box' }}')">
                                        SUPPRIMER
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}

                    {# ========== PANIER SESSION (Visiteur) - PRODUITS ========== #}
                    {% if panier.produits is defined %}
                        {% for item in panier.produits %}
                            <div class="cart-row glass-premium" data-id="{{ item.produit.id }}" data-type="Cookie">
                                
                                <div class="product-preview">
                                    <div class="img-glow-wrap">
                                        <img src="{{ asset('asset/images/produits/' ~ item.produit.image) }}" 
                                             alt="{{ item.produit.name }}"
                                             onerror="this.src='https://via.placeholder.com/150/FF6B8F/FFFFFF?text=Cookie'">
                                    </div>
                                </div>

                                <div class="product-details">
                                    <span class="product-category">COOKIE ARTISANAL</span>
                                    <h3>{{ item.produit.name }}</h3>
                                    <p class="flavor-notes">Prix unitaire : {{ item.produit.prix|number_format(2, ',', ' ') }} ‚Ç¨</p>
                                </div>

                                <div class="product-qty">
                                    <div class="qty-stepper">
                                        <button onclick="changeQtySession({{ item.produit.id }}, 'Cookie', -1)">‚àí</button>
                                        <input type="text" value="{{ item.quantite }}" readonly>
                                        <button onclick="changeQtySession({{ item.produit.id }}, 'Cookie', 1)">+</button>
                                    </div>
                                </div>

                                <div class="product-price">
                                    <span class="total-item-price">{{ (item.produit.prix * item.quantite)|number_format(2, ',', ' ') }} ‚Ç¨</span>
                                    <button class="btn-remove" onclick="removeItemSession({{ item.produit.id }}, 'Cookie')">
                                        SUPPRIMER
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}

                    {# ========== PANIER SESSION - BOXES FIXES ========== #}
                    {% if panier.boxes is defined %}
                        {% for item in panier.boxes %}
                            <div class="cart-row glass-premium" data-id="{{ item.box.id }}" data-type="Box">
                                
                                <div class="product-preview">
                                    <div class="img-glow-wrap">
                                        <img src="{{ asset('asset/images/boxs/' ~ item.box.image) }}" 
                                             alt="{{ item.box.nom }}"
                                             onerror="this.src='https://via.placeholder.com/150/FF6B8F/FFFFFF?text=Box'">
                                    </div>
                                </div>

                                <div class="product-details">
                                    <span class="product-category">BOX {{ item.box.type|upper }}</span>
                                    <h3>{{ item.box.nom }}</h3>
                                    <p class="flavor-notes">Prix unitaire : {{ item.box.prix|number_format(2, ',', ' ') }} ‚Ç¨</p>
                                </div>

                                <div class="product-qty">
                                    <div class="qty-stepper">
                                        <button onclick="changeQtySession({{ item.box.id }}, 'Box', -1)">‚àí</button>
                                        <input type="text" value="{{ item.quantite }}" readonly>
                                        <button onclick="changeQtySession({{ item.box.id }}, 'Box', 1)">+</button>
                                    </div>
                                </div>

                                <div class="product-price">
                                    <span class="total-item-price">{{ (item.box.prix * item.quantite)|number_format(2, ',', ' ') }} ‚Ç¨</span>
                                    <button class="btn-remove" onclick="removeItemSession({{ item.box.id }}, 'Box')">
                                        SUPPRIMER
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}

                    {# ========== PANIER SESSION - BOXES PERSO ========== #}
                    {% if panier.boxes_perso is defined %}
                        {% for key, item in panier.boxes_perso %}
                            <div class="cart-row glass-premium" data-id="{{ key }}" data-type="BoxPerso">
                                
                                <div class="product-preview">
                                    <div class="img-glow-wrap">
                                        <img src="{{ asset('asset/images/boxs/' ~ item.box.image) }}" 
                                             alt="Box Personnalis√©e"
                                             onerror="this.src='https://via.placeholder.com/150/FF6B8F/FFFFFF?text=Box'">
                                    </div>
                                </div>

                                <div class="product-details">
                                    <span class="product-category">BOX PERSONNALIS√âE</span>
                                    <h3>Ma Box Sur-Mesure</h3>
                                    <div class="box-composition">
                                        <p class="flavor-notes">üì¶ Composition :</p>
                                        <div class="composition-list">
                                            {% for produit_id, qty in item.composition %}
                                                <span class="composition-item">
                                                    {{ qty }}x Cookie #{{ produit_id }}
                                                </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <div class="product-qty">
                                    <div class="qty-display">
                                        Quantit√© : 1
                                    </div>
                                </div>

                                <div class="product-price">
                                    <span class="total-item-price">{{ item.box.prix|number_format(2, ',', ' ') }} ‚Ç¨</span>
                                    <button class="btn-remove" onclick="removeItemSession({{ key }}, 'BoxPerso')">
                                        SUPPRIMER
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}

                </section>

                <!-- Sidebar de r√©sum√© -->
                <aside class="cart-sidebar">
                    <div class="summary-card glass-premium sticky-summary">
                        <h2>R√©sum√© de la <span>Commande</span></h2>

                        <!-- Barre de progression pour livraison gratuite -->
                        <div class="shipping-info">
                            {% set seuil_gratuit = 50 %}
                            {% set reste = seuil_gratuit - panier.total %}
                            {% if reste > 0 %}
                                <p>Livraison offerte : <span class="remaining">Plus que {{ reste|number_format(2, ',', ' ') }} ‚Ç¨</span></p>
                                <div class="progress-container">
                                    <div class="progress-bar-fill" style="width: {{ (panier.total / seuil_gratuit * 100)|round }}%;"></div>
                                </div>
                            {% else %}
                                <p class="free-shipping">üéâ Livraison offerte !</p>
                            {% endif %}
                        </div>

                        <!-- D√©tails du r√©sum√© -->
                        <div class="summary-details">
                            <div class="detail-line">
                                <span>Sous-total</span>
                                <span>{{ panier.total|number_format(2, ',', ' ') }} ‚Ç¨</span>
                            </div>
                            <div class="detail-line">
                                <span>Livraison</span>
                                <span>{{ reste > 0 ? '4,50 ‚Ç¨' : 'Gratuite' }}</span>
                            </div>
                            <div class="detail-line total">
                                <span>TOTAL</span>
                                <span class="final-amount">
                                    {{ (reste > 0 ? panier.total + 4.50 : panier.total)|number_format(2, ',', ' ') }} ‚Ç¨
                                </span>
                            </div>
                        </div>

                        <!-- Bouton de commande -->
                        <button id="checkout-button" class="btn-checkout-neon">
                            PASSER AU PAIEMENT
                            <span class="btn-sparkle">‚ú®</span>
                        </button>

                        <!-- Bouton vider le panier -->
                        <form method="POST" action="{{ path('app_panier_vider') }}" onsubmit="return confirm('Vider tout le panier ?')" style="margin-top: 15px;">
                            <button type="submit" class="btn-clear-cart">
                                <i class="fas fa-trash-alt"></i> Vider le panier
                            </button>
                        </form>

                        <!-- Trust badges -->
                        <div class="trust-badges">
                            <span>üõ°Ô∏è Paiement 100% S√©curis√©</span>
                            <span>üöÄ Exp√©dition sous 24h</span>
                        </div>
                    </div>
                </aside>
            </div>
        {% endif %}
    </div>
</main>
{% endblock %}

{% block javascripts %}
      {{ parent() }}
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Passer la cl√© publique Stripe au JavaScript
        const STRIPE_PUBLIC_KEY = '{{ stripe_public_key }}';
    </script>
    <script src="{{ asset('js/panier.js') }}"></script>
{% endblock %}