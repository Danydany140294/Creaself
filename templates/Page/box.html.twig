{% extends 'base.html.twig' %}

{% block title %}{# Titre de la page #}Nos Boxes - CreaSelf{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/box.css') }}">
{% endblock %}

{% block body %}

{# ========== EN-T√äTE PAGE ========== #}
<section>
    <div>
        <h1>{# Titre principal #}Nos Boxes Gourmandes</h1>
        <p>{# Sous-titre #}Des assortiments de cookies pr√©par√©s avec amour</p>
    </div>
</section>

{# ========== BOX PERSONNALISABLE EN VEDETTE ========== #}
{% if box_personnalisable %}{# Affichage conditionnel si box perso existe #}
    <section>
        <div>
            <div>
                <img src="{{ asset('uploads/boxes/' ~ box_personnalisable.image) }}" 
                     alt="{{ box_personnalisable.nom }}">
                <span>Personnalisable</span>
            </div>
            
            <div>
                <h2>{# Nom de la box perso #}{{ box_personnalisable.nom }}</h2>
                <p>{# Description de la box perso #}{{ box_personnalisable.description }}</p>
                
                <div>
                    <div>
                        <i class="fas fa-cookie-bite"></i>
                        <span>12 cookies au choix</span>
                    </div>
                    <div>
                        <i class="fas fa-palette"></i>
                        <span>{# Nombre de saveurs disponibles #}{{ produits|length }} saveurs disponibles</span>
                    </div>
                    <div>
                        <i class="fas fa-gift"></i>
                        <span>Parfait pour offrir</span>
                    </div>
                </div>
                
                <div>
                    <span>Seulement</span>
                    <span>{# Prix de la box perso format√© #}{{ box_personnalisable.prix|number_format(2, ',', ' ') }} ‚Ç¨</span>
                </div>
                
                <button type="button" onclick="openModalBoxPerso()">
                    <i class="fas fa-magic"></i> Composer ma box personnalis√©e
                </button>
            </div>
        </div>
    </section>
{% endif %}

{# ========== BOXES FIXES ========== #}
<section>
    <div>
        <h2>Nos Boxes Pr√™tes √† D√©guster</h2>
        <p>S√©lections gourmandes pr√©-compos√©es par nos soins</p>
    </div>

    <div>
        {% if boxes_fixes|length > 0 %}{# Si des boxes fixes existent #}
            <div>
                {% for box in boxes_fixes %}{# Boucle sur toutes les boxes fixes #}
                    <div>
                        {# Image de la box #}
                        <div>
                            <img src="{{ asset('uploads/boxes/' ~ box.image) }}" 
                                 alt="{{ box.nom }}">
                            
                            {# Badges de stock #}
                            {% if box.stock == 0 %}{# Si rupture de stock #}
                                <span>Rupture</span>
                            {% elseif box.stock < 3 %}{# Si stock faible (moins de 3) #}
                                <span>Derni√®res boxes !</span>
                            {% endif %}
                        </div>

                        {# Informations box #}
                        <div>
                            <h3>{# Nom de la box #}{{ box.nom }}</h3>
                            <p>{# Description de la box #}{{ box.description }}</p>

                            {# Composition de la box #}
                            {% if box.produits|length > 0 %}{# Si la box contient des produits #}
                                <div>
                                    <h4>
                                        <i class="fas fa-cookie-bite"></i> Contient :
                                    </h4>
                                    <ul>
                                        {% for produit in box.produits %}{# Boucle sur les produits de la box #}
                                            <li>
                                                <i class="fas fa-check"></i>
                                                <span>{# Nom du produit dans la box #}{{ produit.name }}</span>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}

                            {# Prix #}
                            <div>
                                <span>{# Prix de la box format√© #}{{ box.prix|number_format(2, ',', ' ') }} ‚Ç¨</span>
                            </div>

                            {# Stock #}
                            <div>
                                {% if box.stock > 0 %}{# Si en stock #}
                                    <i class="fas fa-check-circle"></i>
                                    <span>{# Quantit√© de boxes en stock #}{{ box.stock }} box(es) disponible(s)</span>
                                {% else %}{# Si rupture #}
                                    <i class="fas fa-times-circle"></i>
                                    <span>Rupture de stock</span>
                                {% endif %}
                            </div>

                            {# Formulaire ajout panier #}
                            {% if box.stock > 0 %}{# Formulaire affich√© uniquement si stock disponible #}
                                <form method="POST" 
                                      action="{{ path('app_panier_ajouter_box', {id: box.id}) }}">
                                    
                                    <div>
                                        <label for="quantite_box_{{ box.id }}">Quantit√©:</label>
                                        <div>
                                            <button type="button" 
                                                    onclick="updateBoxQty('quantite_box_{{ box.id }}', -1, 1, {{ box.stock }})"
                                                    aria-label="Diminuer la quantit√©">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            
                                            <input type="number" 
                                                   id="quantite_box_{{ box.id }}"
                                                   name="quantite" 
                                                   value="1" 
                                                   min="1" 
                                                   max="{{ box.stock }}"
                                                   readonly>
                                            
                                            <button type="button" 
                                                    onclick="updateBoxQty('quantite_box_{{ box.id }}', 1, 1, {{ box.stock }})"
                                                    aria-label="Augmenter la quantit√©">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <button type="submit">
                                        <i class="fas fa-shopping-cart"></i> Ajouter au panier
                                    </button>
                                </form>
                            {% else %}{# Bouton d√©sactiv√© si rupture #}
                                <button disabled>
                                    <i class="fas fa-ban"></i> Indisponible
                                </button>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}{# Si aucune box fixe disponible #}
            <div>
                <i class="fas fa-box-open fa-3x"></i>
                <p>Aucune box fixe disponible pour le moment.</p>
                <a href="{{ path('app_home') }}">
                    <i class="fas fa-arrow-left"></i> Retour √† l'accueil
                </a>
            </div>
        {% endif %}
    </div>
</section>

{# ========== CTA BOX PERSO (bas de page) ========== #}
{% if box_personnalisable %}{# Call-to-action pour la box personnalisable #}
    <section>
        <div>
            <div>
                <i class="fas fa-magic"></i>
            </div>
            <div>
                <h3>Tu veux une box unique ?</h3>
                <p>Compose ta box personnalis√©e avec exactement les cookies que tu pr√©f√®res !</p>
            </div>
            <button type="button" onclick="openModalBoxPerso()">
                <i class="fas fa-cookie-bite"></i> Cr√©er ma box maintenant
            </button>
        </div>
    </section>
{% endif %}

{# Inclure la modal box personnalisable #}
{% if box_personnalisable %}
    {% include 'component/_modal_box_perso.html.twig' %}
{% endif %}

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    
    <script>
        // ========== GESTION DES QUANTIT√âS BOXES ========== 
        function updateBoxQty(inputId, delta, min, max) {
            const input = document.getElementById(inputId);
            let currentValue = parseInt(input.value) || min;
            let newValue = currentValue + delta;
            
            if (newValue >= min && newValue <= max) {
                input.value = newValue;
            }
        }

        // ========== ANIMATION AU SCROLL ========== 
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.box-card');
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('fade-in');
                    }
                });
            }, {
                threshold: 0.1
            });

            cards.forEach(card => {
                observer.observe(card);
            });
        });

        // ========== GESTION MODAL BOX PERSO ========== 
        let selectedCookies = {};

        function openModalBoxPerso() {
            console.log('üöÄ Ouverture de la modal');
            const modal = document.getElementById('modalBoxPerso');
            
            if (modal) {
                modal.style.cssText = `
                    display: block !important;
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                    background: rgba(0, 0, 0, 0.75) !important;
                    z-index: 99999 !important;
                    overflow-y: auto !important;
                    padding: 20px !important;
                `;
                document.body.style.overflow = 'hidden';
                console.log('‚úÖ Modal affich√©e avec succ√®s');
            } else {
                console.error('‚ùå Modal #modalBoxPerso introuvable dans le DOM !');
            }
        }

        function closeModalBoxPerso() {
            const modal = document.getElementById('modalBoxPerso');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                resetSelection();
            }
        }

        function resetSelection() {
            selectedCookies = {};
            
            document.querySelectorAll('.input-qty-modal').forEach(input => {
                input.value = 0;
                const produitId = input.id.replace('qty_', '');
                updateButtonStates(produitId, 0);
            });
            
            updateCounter();
        }

        function updateCookieQty(produitId, delta, maxStock) {
            const input = document.getElementById(`qty_${produitId}`);
            if (!input) return;
            
            let currentQty = parseInt(input.value) || 0;
            let newQty = currentQty + delta;
            
            let totalCookies = getTotalCookies() - currentQty;
            
            if (newQty < 0) newQty = 0;
            if (newQty > maxStock) newQty = maxStock;
            if (totalCookies + newQty > 12) newQty = 12 - totalCookies;
            
            input.value = newQty;
            
            if (newQty > 0) {
                selectedCookies[`produit_${produitId}`] = newQty;
            } else {
                delete selectedCookies[`produit_${produitId}`];
            }
            
            updateButtonStates(produitId, newQty);
            updateCounter();
        }

        function updateButtonStates(produitId, qty) {
            const card = document.querySelector(`[data-produit-id="${produitId}"]`);
            if (!card) return;
            
            const minusBtn = card.querySelector('.btn-minus-modal');
            const plusBtn = card.querySelector('.btn-plus-modal');
            
            if (minusBtn) {
                minusBtn.disabled = qty === 0;
            }
            
            if (plusBtn) {
                const totalCookies = getTotalCookies();
                plusBtn.disabled = totalCookies >= 12;
            }
        }

        function getTotalCookies() {
            return Object.values(selectedCookies).reduce((sum, qty) => sum + qty, 0);
        }

        function updateCounter() {
            const total = getTotalCookies();
            const counterElement = document.getElementById('cookiesSelected');
            const progressBar = document.getElementById('progressBar');
            const btnValider = document.getElementById('btnValiderBox');
            
            if (!counterElement || !progressBar || !btnValider) return;
            
            counterElement.textContent = total;
            
            const percentage = (total / 12) * 100;
            progressBar.style.width = `${percentage}%`;
            
            if (total === 12) {
                progressBar.style.backgroundColor = '#10b981';
                btnValider.disabled = false;
            } else if (total > 12) {
                progressBar.style.backgroundColor = '#ef4444';
                btnValider.disabled = true;
            } else {
                progressBar.style.backgroundColor = '#3b82f6';
                btnValider.disabled = true;
            }
            
            document.querySelectorAll('.btn-plus-modal').forEach(btn => {
                const card = btn.closest('.cookie-card');
                if (!card) return;
                const produitId = card.getAttribute('data-produit-id');
                const currentQty = parseInt(document.getElementById(`qty_${produitId}`).value) || 0;
                updateButtonStates(produitId, currentQty);
            });
        }

        async function validerBoxPerso() {
            const total = getTotalCookies();
            
            if (total !== 12) {
                alert('Vous devez s√©lectionner exactement 12 cookies !');
                return;
            }
            
            const data = {
                cookies: selectedCookies
            };
            
            try {
                const response = await fetch('/panier/ajouter-box-personnalisable', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModalBoxPerso();
                    alert(result.message);
                    location.reload();
                } else {
                    alert(result.message || 'Une erreur est survenue');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Une erreur est survenue lors de l\'ajout au panier');
            }
        }

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('modalBoxPerso');
            if (modal && event.target === modal) {
                closeModalBoxPerso();
            }
        });
    </script>
{% endblock %}

