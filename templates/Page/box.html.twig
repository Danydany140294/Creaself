{% extends 'base.html.twig' %}

{% block title %}Nos Cookies - CreaSelf{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/box.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@300;400;500;600&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body %}

{# ========== EN-TÊTE ========== #}
<div class="nc-hero-content">
    <h1>Nos <span>Cookies</span></h1>
</div>

<main class="container">
    <div class="main-layout">
        
        {# ========== COLONNE PRINCIPALE - BOXES ========== #}
        <div class="boxes-main">
            
            {# ========== BOX PERSONNALISABLE EN VEDETTE ========== #}
            {% if box_personnalisable %}
            <div class="featured-box">
                <div class="featured-box-inner">
                    <div class="featured-box-image">
                        {# ✅ CORRECTION : Dossier 'boxs' (sans 'e') #}
                        <img src="{{ asset('asset/images/boxs/' ~ box_personnalisable.image) }}" 
                             alt="{{ box_personnalisable.nom }}">
                        <span class="featured-badge">
                            <i class="fas fa-magic"></i> Personnalisable
                        </span>
                    </div>
                    
                    <div class="featured-box-content">
                        <span class="featured-label">Collection Signature</span>
                        <h2 class="featured-title">{{ box_personnalisable.nom }}</h2>
                        <p class="featured-description">{{ box_personnalisable.description }}</p>
                        
                        <div class="featured-benefits">
                            <div class="benefit-item">
                                <i class="fas fa-cookie-bite"></i>
                                <span>12 cookies</span>
                            </div>
                            <div class="benefit-item">
                                <i class="fas fa-palette"></i>
                                <span>{{ produits|length }} saveurs</span>
                            </div>
                            <div class="benefit-item">
                                <i class="fas fa-gift"></i>
                                <span>Cadeau parfait</span>
                            </div>
                        </div>
                        
                        <div class="featured-footer">
                            <div class="featured-price">
                                <span class="price-label">Prix</span>
                                <span class="price-value">{{ box_personnalisable.prix|number_format(2, ',', ' ') }} €</span>
                            </div>
                            <button type="button" onclick="openModalBoxPerso()" class="btn-featured">
                                <i class="fas fa-magic"></i> Composer ma box
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {# ========== BOXES FIXES ========== #}
            <div class="boxes-section">
                <div class="section-header">
                    <h2 class="section-title">Collections Prêtes à Déguster</h2>
                    <p class="section-subtitle">Nos boxes pré-composées avec soin</p>
                </div>

                {% if boxes_fixes|length > 0 %}
                    <div class="boxes-list">
                        {% for box in boxes_fixes %}
                        <div class="box-card">
                            <div class="box-image">
                                {# ✅ CORRECTION : Dossier 'boxs' (sans 'e') #}
                                <img src="{{ asset('asset/images/boxs/' ~ box.image) }}" 
                                     alt="{{ box.nom }}">
                                
                                {% if box.stock == 0 %}
                                    <span class="stock-badge out-of-stock">Rupture</span>
                                {% elseif box.stock < 3 %}
                                    <span class="stock-badge low-stock">Dernières !</span>
                                {% endif %}
                            </div>
                            
                            <div class="box-content">
                                <span class="box-label">Box Signature</span>
                                <h3 class="box-title">{{ box.nom }}</h3>
                                <p class="box-description">{{ box.description }}</p>
                                
                                {% if box.produits|length > 0 %}
                                <div class="box-composition">
                                    <h4 class="composition-title">
                                        <i class="fas fa-cookie-bite"></i> Composition :
                                    </h4>
                                    <div class="composition-grid">
                                        {% for produit in box.produits %}
                                        <div class="composition-item">
                                            <i class="fas fa-check"></i>
                                            <span>{{ produit.name }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <div class="box-footer">
                                    <div class="box-info">
                                        <span class="stock-info">
                                            {% if box.stock > 0 %}
                                                <i class="fas fa-check-circle"></i> {{ box.stock }} disponible(s)
                                            {% else %}
                                                <i class="fas fa-times-circle"></i> Rupture de stock
                                            {% endif %}
                                        </span>
                                        <span class="box-price">{{ box.prix|number_format(2, ',', ' ') }} €</span>
                                    </div>
                                    
                                    {% if box.stock > 0 %}
                                    <form method="POST" action="{{ path('app_panier_ajouter_box', {id: box.id}) }}" class="box-form">
                                        <div class="qty-controls">
                                            <button type="button" 
                                                    onclick="updateBoxQty('quantite_box_{{ box.id }}', -1, 1, {{ box.stock }})"
                                                    class="qty-btn">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            
                                            <input type="number" 
                                                   id="quantite_box_{{ box.id }}"
                                                   name="quantite" 
                                                   value="1" 
                                                   min="1" 
                                                   max="{{ box.stock }}"
                                                   readonly
                                                   class="qty-input">
                                            
                                            <button type="button" 
                                                    onclick="updateBoxQty('quantite_box_{{ box.id }}', 1, 1, {{ box.stock }})"
                                                    class="qty-btn">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                        
                                        <button type="submit" class="btn-add-cart">
                                            <i class="fas fa-shopping-cart"></i> Ajouter
                                        </button>
                                    </form>
                                    {% else %}
                                    <button disabled class="btn-disabled">
                                        <i class="fas fa-ban"></i> Indisponible
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>Aucune box disponible pour le moment.</p>
                        <a href="{{ path('app_home') }}" class="btn-back">
                            <i class="fas fa-arrow-left"></i> Retour à l'accueil
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        {# ========== SIDEBAR - MA BOX PERSONNALISÉE ========== #}
        {% if box_personnalisable %}
        <aside class="sidebar">
            <div class="sidebar-content">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">Ma Box Perso</h2>
                    <p class="sidebar-subtitle">Compose ta sélection</p>
                </div>

                <div class="box-preview">
                    <div class="preview-header">
                        <span class="preview-label">Progression</span>
                        <span class="preview-count">0 / 12 Cookies</span>
                    </div>
                    <div class="box-slots">
                        {% for i in 1..12 %}
                        <div class="box-slot"></div>
                        {% endfor %}
                    </div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="sidebar-products">
                    {% for produit in produits|slice(0, 5) %}
                    <div class="sidebar-product">
                        <div class="product-info">
                            <div class="product-icon">
                                <i class="fas fa-cookie-bite"></i>
                            </div>
                            <span class="product-name">{{ produit.name }}</span>
                        </div>
                        <span class="product-price">{{ produit.prix|number_format(2, ',', ' ') }}€</span>
                    </div>
                    {% endfor %}
                </div>

                <div class="sidebar-footer">
                    <div class="total-info">
                        <span class="total-label">Total estimé</span>
                        <span class="total-price">{{ box_personnalisable.prix|number_format(2, ',', ' ') }} €</span>
                    </div>
                    <button type="button" onclick="openModalBoxPerso()" class="btn-customize">
                        <i class="fas fa-magic"></i> Créer ma box
                    </button>
                </div>
            </div>
        </aside>
        {% endif %}
    </div>
</main>

{# ========== MODAL BOX PERSONNALISABLE ========== #}
{% if box_personnalisable %}
<div id="modalBoxPerso" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-wrapper">
        <div class="modal-container">
            
            {# Header #}
            <div class="modal-header">
                <div class="modal-header-content">
                    <h2 class="modal-title">Compose ta Box Personnalisée</h2>
                    <p class="modal-subtitle">Sélectionne exactement 12 cookies</p>
                </div>
                <button type="button" onclick="closeModalBoxPerso()" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            {# Progress Bar #}
            <div class="modal-progress">
                <div class="progress-info">
                    <span class="progress-label">Cookies sélectionnés</span>
                    <span class="progress-count">
                        <span id="cookiesSelected">0</span> / 12
                    </span>
                </div>
                <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar-fill"></div>
                </div>
            </div>

            {# Body - Cookies Grid #}
            <div class="modal-body">
                <div class="cookies-grid">
                    {% for produit in produits %}
                    <div class="cookie-card" data-produit-id="{{ produit.id }}">
                        <div class="cookie-image">
                            {# ✅ CORRECTION : Même chemin que produits.html.twig #}
                            <img src="{{ asset('asset/images/produits/' ~ produit.image) }}" 
                                 alt="{{ produit.name }}">
                            {% if produit.stock < 5 %}
                                <span class="cookie-badge">Stock limité</span>
                            {% endif %}
                        </div>
                        
                        <div class="cookie-info">
                            <h4 class="cookie-name">{{ produit.name }}</h4>
                            <p class="cookie-price">{{ produit.prix|number_format(2, ',', ' ') }} € / pièce</p>
                            
                            <div class="cookie-controls">
                                <button type="button" 
                                        class="cookie-btn btn-minus"
                                        onclick="updateCookieQty({{ produit.id }}, -1, {{ produit.stock }})"
                                        disabled>
                                    <i class="fas fa-minus"></i>
                                </button>
                                
                                <input type="number" 
                                       id="qty_{{ produit.id }}"
                                       class="cookie-qty-input"
                                       value="0" 
                                       min="0" 
                                       max="{{ produit.stock }}"
                                       readonly>
                                
                                <button type="button" 
                                        class="cookie-btn btn-plus"
                                        onclick="updateCookieQty({{ produit.id }}, 1, {{ produit.stock }})">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            {# Footer #}
            <div class="modal-footer">
                <button type="button" onclick="resetSelection()" class="btn-reset">
                    <i class="fas fa-redo"></i> Réinitialiser
                </button>
                <button type="button" 
                        id="btnValiderBox" 
                        onclick="validerBoxPerso()" 
                        disabled
                        class="btn-validate">
                    <i class="fas fa-check"></i> Ajouter au panier ({{ box_personnalisable.prix|number_format(2, ',', ' ') }} €)
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/box.js') }}"></script>
{% endblock %}