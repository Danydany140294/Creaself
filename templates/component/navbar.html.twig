{# templates/component/navbar.html.twig #}

<!-- Bandeau promo -->
<div class="promo-banner">
    <div class="promo-banner-content">
        <span>üéâ Livraison offerte d√®s 20‚Ç¨</span>
        <span>üç™ Nouveaux cookies chaque semaine</span>
        <span>‚ú® Cookies d'exception faits maison</span>
        <span>üéâ Livraison offerte d√®s 20‚Ç¨</span>
        <span>üç™ Nouveaux cookies chaque semaine</span>
        <span>‚ú® Cookies d'exception faits maison</span>
    </div>
</div>

<!-- Logo -->
<div class="logo-section">
    <a href="{{ path('app_home') }}">
        <img src="{{ asset('asset/perline.jpg') }}" alt="Logo Premium Cookie Shop">
    </a>
</div>

<!-- Overlay pour menu mobile -->
<div class="nav-overlay" id="navOverlay" onclick="closeMobileMenu()"></div>

<!-- Navbar -->
<nav class="navbar">
    <!-- Bouton Burger (visible uniquement sur mobile) -->
    <button class="burger-menu" id="burgerMenu" onclick="toggleMobileMenu()" aria-label="Menu de navigation">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Liens de navigation centr√©s -->
    <ul class="nav-links" id="navLinks">
        <li><a href="{{ path('app_quisommesnous') }}" onclick="closeMobileMenu()">Qui sommes nous ?</a></li>
        <li><a href="{{ path('app_produits') }}" onclick="closeMobileMenu()">Nos Cookies</a></li>
        <li><a href="{{ path('app_box') }}" onclick="closeMobileMenu()">Nos Box</a></li>
        <li><a href="{{ path('app_contact') }}" onclick="closeMobileMenu()">Contactez-nous</a></li>
    </ul>

    <!-- Boutons √† droite -->
    <div class="nav-buttons">
        <!-- Bouton Panier -->
        <button onclick="openModalPanier()" class="btn btn-panier" type="button" aria-label="Voir le panier">
            <i class="fa-solid fa-basket-shopping"></i>
            <span>Panier</span>
            <span class="cart-badge" id="cartBadge">0</span>
        </button>

        <!-- SI CONNECT√â : Menu utilisateur avec dropdown -->
        {% if app.user %}
            <div class="user-menu">
                <button class="btn btn-user" onclick="toggleUserMenu(event)" aria-label="Menu utilisateur">
                    <i class="fas fa-user-circle"></i>
                    <span>{{ app.user.prenom ?? 'Mon compte' }}</span>
                    <i class="fas fa-chevron-down"></i>
                </button>

                <div class="dropdown-menu">
                    <div class="dropdown-header">
                        <div class="user-name">{{ app.user.prenom }} {{ app.user.nom }}</div>
                        <div class="user-email">{{ app.user.email }}</div>
                    </div>
                    
                    <a href="{{ path('app_user_dashboard') }}" class="dropdown-item">
                        <i class="fas fa-user-cog"></i>
                        Mon profil
                    </a>
                    
                    <a href="{{ path('app_user_dashboard') }}#adresses" class="dropdown-item">
                        <i class="fas fa-map-marker-alt"></i>
                        Mes adresses
                    </a>
                    
                    <a href="{{ path('app_user_dashboard') }}#paiement" class="dropdown-item">
                        <i class="fas fa-credit-card"></i>
                        Moyens de paiement
                    </a>
                    
                    <a href="{{ path('app_user_dashboard') }}#commandes" class="dropdown-item">
                        <i class="fas fa-box"></i>
                        Mes commandes
                    </a>
                    
                    <a href="{{ path('app_logout') }}" class="dropdown-item logout">
                        <i class="fas fa-sign-out-alt"></i>
                        D√©connexion
                    </a>
                </div>
            </div>
        {% else %}
            <!-- SI NON CONNECT√â : Bouton Login simple -->
            <a href="{{ path('app_login') }}" class="btn btn-login" aria-label="Se connecter">
                <i class="fas fa-sign-in-alt"></i>
                <span>Login</span>
            </a>
        {% endif %}
    </div>
</nav>

<!-- JavaScript de la navbar -->
<script>
console.log('‚úÖ Navbar JavaScript charg√©');

// ========================================
// MENU MOBILE BURGER
// ========================================
function toggleMobileMenu() {
    const navLinks = document.getElementById('navLinks');
    const burgerMenu = document.getElementById('burgerMenu');
    const navOverlay = document.getElementById('navOverlay');
    
    if (navLinks && burgerMenu && navOverlay) {
        navLinks.classList.toggle('active');
        burgerMenu.classList.toggle('active');
        navOverlay.classList.toggle('active');
    }
}

function closeMobileMenu() {
    const navLinks = document.getElementById('navLinks');
    const burgerMenu = document.getElementById('burgerMenu');
    const navOverlay = document.getElementById('navOverlay');
    
    if (navLinks && burgerMenu && navOverlay) {
        navLinks.classList.remove('active');
        burgerMenu.classList.remove('active');
        navOverlay.classList.remove('active');
    }
}

// Fermer le menu mobile avec la touche Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeMobileMenu();
    }
});

// ========================================
// MENU UTILISATEUR DROPDOWN
// ========================================
function toggleUserMenu(event) {
    if (event) event.stopPropagation();
    
    const userMenu = document.querySelector('.user-menu');
    if (userMenu) {
        userMenu.classList.toggle('active');
    }
}

// Fermer le menu utilisateur en cliquant ailleurs
document.addEventListener('click', function(event) {
    const userMenu = document.querySelector('.user-menu');
    if (!userMenu) return;
    
    if (!userMenu.contains(event.target)) {
        userMenu.classList.remove('active');
    }
});

// ========================================
// MODAL PANIER
// ========================================
function openModalPanier() {
    const modal = document.getElementById('modalPanier');
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        chargerPanier();
    } else {
        console.warn('‚ö†Ô∏è Modal panier introuvable');
    }
}

function closeModalPanier() {
    const modal = document.getElementById('modalPanier');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

// ========================================
// API PANIER
// ========================================
async function chargerPanier() {
    try {
        const response = await fetch('/panier/api/panier');
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const data = await response.json();
        if (data.success) {
            updateCartBadge(data.nombre_articles);
        }
    } catch (error) {
        console.error('‚ùå Erreur panier:', error);
        updateCartBadge(0);
    }
}

function updateCartBadge(count) {
    const badge = document.getElementById('cartBadge');
    if (!badge) return;
    
    badge.textContent = count;
    
    if (count === 0) {
        badge.classList.remove('show');
    } else {
        badge.classList.add('show');
    }
}

// ========================================
// GESTION DU RESIZE - Fermer le menu mobile si on passe en desktop
// ========================================
let resizeTimer;
window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
        // Si on d√©passe 768px, fermer le menu mobile
        if (window.innerWidth > 768) {
            closeMobileMenu();
        }
    }, 250);
});

// ========================================
// INITIALISATION
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM charg√© - Navbar');
    
    // Charger le panier
    chargerPanier();
    
    // Fermer modal panier en cliquant dehors
    const modalPanier = document.getElementById('modalPanier');
    if (modalPanier) {
        modalPanier.addEventListener('click', function(event) {
            if (event.target === modalPanier) {
                closeModalPanier();
            }
        });
    }
    
    // Log de la taille de l'√©cran pour debug
    console.log('üì± Largeur √©cran:', window.innerWidth + 'px');
});
</script>
