{# templates/panier/_modal_panier.html.twig #}

{# Modal Panier #}
<div id="modalPanier" style="display: none;">
    <div onclick="closeModalPanier()"></div>
    
    <div>
        {# En-t√™te #}
        <div>
            <h2>
                <i class="fa-solid fa-basket-shopping"></i>
                Mon Panier
            </h2>
            <button onclick="closeModalPanier()" aria-label="Fermer">
                <i class="fas fa-times"></i>
            </button>
        </div>

        {# Corps de la modal avec le contenu du panier #}
        <div id="panierContent">
            <div>
                <i class="fas fa-spinner fa-spin"></i>
                <p>Chargement du panier...</p>
            </div>
        </div>

        {# Pied de modal #}
        <div>
            <button type="button" onclick="closeModalPanier()">
                <i class="fas fa-times"></i> Continuer mes achats
            </button>
            <a href="{{ path('app_panier_index') }}">
                <i class="fas fa-shopping-cart"></i> Voir le panier complet
            </a>
        </div>
    </div>
</div>

{# ========== STYLES CSS ========== #}
<link rel="stylesheet" href="{{ asset('css/modal-panier.css') }}">

{# ========== JAVASCRIPT ========== #}
<script>
// Ouvrir la modal et charger le panier
async function openModalPanier() {
    const modal = document.getElementById('modalPanier');
    const panierContent = document.getElementById('panierContent');
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Afficher le loading
    panierContent.innerHTML = `
        <div class="loading-panier">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Chargement du panier...</p>
        </div>
    `;
    
    try {
        // Appel AJAX pour r√©cup√©rer le panier en JSON
        const response = await fetch('/panier/api/panier');
        
        if (!response.ok) {
            throw new Error('Erreur lors du chargement du panier');
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.message || 'Erreur inconnue');
        }
        
        if (data.is_empty || data.items.length === 0) {
            panierContent.innerHTML = `
                <div class="panier-vide">
                    <i class="fa-solid fa-basket-shopping"></i>
                    <h3>Votre panier est vide</h3>
                    <p>Ajoutez des produits pour commencer !</p>
                </div>
            `;
        } else {
            afficherPanier(data);
        }
        
    } catch (error) {
        console.error('Erreur:', error);
        panierContent.innerHTML = `
            <div class="panier-vide">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erreur de chargement</h3>
                <p>Impossible de charger le panier. Veuillez r√©essayer.</p>
            </div>
        `;
    }
}

// Afficher le contenu du panier
function afficherPanier(data) {
    const panierContent = document.getElementById('panierContent');
    
    let itemsHTML = '<div class="panier-items">';
    
    data.items.forEach(item => {
        const imageUrl = item.image ? `/uploads/${item.type === 'Cookie' ? 'produits' : 'boxes'}/${item.image}` : '';
        
        itemsHTML += `
            <div class="panier-item">
                ${imageUrl ? `<img src="${imageUrl}" alt="${item.nom}" class="panier-item-image" onerror="this.src='/images/placeholder.jpg'">` : ''}
                <div class="panier-item-info">
                    <div class="panier-item-name">${item.nom}</div>
                    <div class="panier-item-type">${item.type}</div>
                    <div class="panier-item-quantity">Quantit√©: ${item.quantite}</div>
                    ${item.composition ? `
                        <div class="panier-item-composition">
                            <small>üì¶ ${item.composition.map(c => `${c.quantite}x ${c.nom}`).join(', ')}</small>
                        </div>
                    ` : ''}
                </div>
                <div class="panier-item-price">${item.sous_total.toFixed(2).replace('.', ',')} ‚Ç¨</div>
            </div>
        `;
    });
    
    itemsHTML += '</div>';
    
    itemsHTML += `
        <div class="panier-total">
            <div class="panier-total-row">
                <span class="panier-total-label">Total:</span>
                <span class="panier-total-value">${data.total.toFixed(2).replace('.', ',')} ‚Ç¨</span>
            </div>
        </div>
    `;
    
    panierContent.innerHTML = itemsHTML;
}

// Fermer la modal
function closeModalPanier() {
    document.getElementById('modalPanier').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Fermer en cliquant sur √âchap
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModalPanier();
    }
});

// Emp√™cher la fermeture en cliquant dans la modal
document.addEventListener('DOMContentLoaded', function() {
    const modalContent = document.querySelector('.modal-content-panier');
    if (modalContent) {
        modalContent.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }
});
</script>