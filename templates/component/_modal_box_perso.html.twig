{# Modal Box Personnalisable #}
<div id="modalBoxPerso" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <h2>
                <i class="fas fa-magic"></i> 
                Compose ta box personnalisée
            </h2>
            <button type="button" class="btn-close-modal" onclick="closeModalBoxPerso()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            {# Compteur de cookies sélectionnés #}
            <div class="cookies-counter">
                <div class="counter-info">
                    <i class="fas fa-cookie-bite"></i>
                    <span id="cookiesSelected">0</span> / 12 cookies sélectionnés
                </div>
                <div class="progress-bar">
                    <div id="progressBar" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>

            {# Liste des cookies disponibles #}
            <div class="cookies-grid">
                {% for produit in produits %}
                    {# ✅ produits est maintenant un array simple, pas des objets Doctrine #}
                    {% if produit.stock > 0 %}
                        <div class="cookie-card" data-produit-id="{{ produit.id }}">
                            <div class="cookie-image-wrapper">
                                <img src="{{ asset('uploads/produits/' ~ produit.image) }}" 
                                     alt="{{ produit.name }}"
                                     class="cookie-image">
                                
                                {% if produit.stock < 5 %}
                                    <span class="badge-stock-faible">Stock limité</span>
                                {% endif %}
                            </div>

                            <div class="cookie-info">
                                <h4 class="cookie-name">{{ produit.name }}</h4>
                                <p class="cookie-price">{{ produit.prix|number_format(2, ',', ' ') }} €</p>
                                <p class="cookie-stock">Stock: {{ produit.stock }}</p>
                            </div>

                            {# Sélecteur de quantité #}
                            <div class="quantity-selector-modal">
                                <button type="button" 
                                        class="btn-qty-modal btn-minus-modal" 
                                        onclick="updateCookieQty({{ produit.id }}, -1, {{ produit.stock }})"
                                        disabled>
                                    <i class="fas fa-minus"></i>
                                </button>
                                
                                <input type="number" 
                                       id="qty_{{ produit.id }}"
                                       class="input-qty-modal"
                                       value="0" 
                                       min="0" 
                                       max="{{ produit.stock }}"
                                       readonly>
                                
                                <button type="button" 
                                        class="btn-qty-modal btn-plus-modal" 
                                        onclick="updateCookieQty({{ produit.id }}, 1, {{ produit.stock }})">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="modal-footer">
            <div class="footer-info">
                <p class="prix-box">Prix total: <strong>{{ box_personnalisable.prix|number_format(2, ',', ' ') }} €</strong></p>
                <p class="info-text">
                    <i class="fas fa-info-circle"></i> 
                    Sélectionnez exactement 12 cookies
                </p>
            </div>
            
            <div class="footer-actions">
                <button type="button" class="btn-annuler" onclick="closeModalBoxPerso()">
                    Annuler
                </button>
                <button type="button" 
                        id="btnValiderBox" 
                        class="btn-valider-box" 
                        onclick="validerBoxPerso()"
                        disabled>
                    <i class="fas fa-shopping-cart"></i> 
                    Ajouter au panier
                </button>
            </div>
        </div>
    </div>
</div>